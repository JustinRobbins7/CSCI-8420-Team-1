# Team 1 Designing for Software Security Engineering: Liberapay

Written by Team 1:
Joel Allou, Mohammad H. Al Huneidi, Miti Mareddy, Justin Robbins, and Nicholas Sabata

Link to Liberapay GitHub: [Liberapay Project](https://github.com/liberapay/liberapay.com)


## 1. Threat Modeling

### 1.1. Liberapay Payment Data Flow Diagram
![Data Flow Diagram](/Images/LiberapayDFD.PNG)

### 1.2. Liberapay Threat Modeling Report
HTML Report Generated By Microsoft TMT: [https://justinrobbins7.github.io/CSCI-8420-Team-1/LiberapayThreatAnalysis.htm](https://justinrobbins7.github.io/CSCI-8420-Team-1/LiberapayThreatAnalysis.htm)

## 2. Observations

1. _Spoofing the Liberapay Process_
- Description:	Liberapay may be spoofed by an attacker and this may lead to information disclosure by User. Consider using a standard authentication mechanism to identify the destination process.
- Justification:	Liberapay is not responsible for users clicking on spoofed links. Spoofs caused by faulty encryption should be mitigated by the use of HTTPS.
- __Observation:__

2. _Spoofing the User External Entity_
- Description:	User may be spoofed by an attacker and this may lead to unauthorized access to Liberapay. Consider using a standard authentication mechanism to identify the external entity.
- Justification:	Liberapay implements a standard authentication mechanism as well as two-factor authentication.
- __Observation:__

3. _Potential Lack of Input Validation for Liberapay_
- Description:	Data flowing across Credentials may be tampered with by an attacker. This may lead to a denial of service attack against Liberapay or an elevation of privilege attack against Liberapay or an information disclosure by Liberapay. Failure to verify that input is as expected is a root cause of a very large number of exploitable issues. Consider all paths and the way they handle data. Verify that all input is verified for correctness using an approved list input validation approach.
- Justification:	Liberapay implements input sanitization and encrypted communications to prevent tampering.
- __Observation:__

4. _Not Applicable_

5. _Data Flow Sniffing_
- Description:	Data flowing across Credentials may be sniffed by an attacker. Depending on what type of data an attacker can read, it may be used to attack other parts of the system or simply be a disclosure of information leading to compliance violations. Consider encrypting the data flow.
- Justification:	Liberapay encrypted traffic via HTTPS protocols.
- __Observation:__

6. _Potential Process Crash or Stop for Liberapay_
- Description:	Liberapay crashes, halts, stops or runs slowly; in all cases violating an availability metric.
- Justification:	May be outstanding issues that cause this behavior; however, Liberapay is generally a functional application and the threat of this is low.
- __Observation:__

7. _Data Flow Credentials Is Potentially Interrupted_
- Description:	An external agent interrupts data flowing across a trust boundary in either direction.
- Justification:	The use of HTTPS protocol should mitigate this, but it warrants further investigation concerning the possibility of this attack.
- __Observation:__

8. _Not Applicable_

9. _Liberapay May be Subject to Elevation of Privilege Using Remote Code Execution_
- Description:	User may be able to remotely execute code for Liberapay.
- Justification:	Should investigation if Liberapay authenticates user input and sanitizes all inputs.
- __Observation:__

10. _Elevation by Changing the Execution Flow in Liberapay_
- Description: An attacker may pass data into Liberapay in order to change the flow of program execution within Liberapay to the attacker's choosing.
- Justification: Need to investigate how ubiquitious Liberapay's sanitization is.
- __Observation:__ This issue has been mitigated by a recent commit to the Liberapay system. Liberapay provides ubiquitous sanitization on user input based on the id of the element. More spicifically, this functionality is limited to sanitization in the front-end system by adding required elements for given inputs and enforcing input types on them. Since this interaction occurs between the users and the Liberapay sytstem, having sanitization on inputs that can be passed from a user mitigates the issue of concern. 

Added in commit [#8a99590 ](https://github.com/liberapay/liberapay.com/commit/8a995901798e939968aaa367ea346b56b3688488)

11. _Cross Site Request Forgery_
- Description: Cross-site request forgery (CSRF or XSRF) is a type of attack in which an attacker forces a user's browser to make a forged request to a vulnerable site by exploiting an existing trust relationship between the browser and the vulnerable web site.  In a simple scenario, a user is logged in to web site A using a cookie as a credential.  The other browses to web site B.  Web site B returns a page with a hidden form that posts to web site A.  Since the browser will carry the user's cookie to web site A, web site B now can take any action on web site A, for example, adding an admin to an account.  The attack can be used to exploit any requests that the browser automatically authenticates, e.g. by session cookie, integrated authentication, IP whitelisting. The attack can be carried out in many ways such as by luring the victim to a site under control of the attacker, getting the user to click a link in a phishing email, or hacking a reputable web site that the victim will visit. The issue can only be resolved on the server side by requiring that all authenticated state-changing requests include an additional piece of secret payload (canary or CSRF token) which is known only to the legitimate web site and the browser and which is protected in transit through SSL/TLS. See the Forgery Protection property on the flow stencil for a list of mitigations.
- Justification: Use of HTTPS protocols and encryption should mitigate this threat by protected session information in transit.
- __Observation:__ The Liberapay system addresses this security concern by protecting session information in transit. It has CSRF protection in place, as well as encryption on site data. The CSRF protection is done via a token-generation procedure which is added to each state. Additionally, the Liberapay system encrypts sensitive data in transit between the user and the system. This is done via a modified Fernet protocol. First messages in plain text are serialized using the Concise Binary Object Representation. After which, they're encyrpted with an AES cipher as done in the regular Fernet protocol. It should be noted however, that Liberapay does not explicitly enforce the use of the HTTPS protocol for requests/replies from a User. While the codebase seems to enforce the use of HTTPS for internal links and form submissions, a gap exists when interacting from an external e-mail and the system. In this case, the mitigation that exists involves a hit-rate limitation on requests that arrive without HTTPS, as well as replying with a security message 'http-unsafe'.

CSRF Protection can be found [here](https://github.com/liberapay/liberapay.com/blob/83a1d767c7723d8bc0fff9aa5bb8bb9b8e4e8205/liberapay/security/csrf.py)
Encryption is currently done via the Fernet protocol and can be found [here](https://github.com/liberapay/liberapay.com/blob/77f6df133ee434495e2f268d3682a711142513ea/liberapay/security/crypto.py)
HTTP rate limitation can be found [here](https://github.com/liberapay/liberapay.com/commit/f73b4f23d28aaf19b0e1e6c0b257397e40dfee77)

12. _Spoofing of the Payment Host External Destination Entity_
- Description: Payment Host may be spoofed by an attacker and this may lead to data being sent to the attacker's target instead of Payment Host. Consider using a standard authentication mechanism to identify the external entity.
- Justification: Both Liberapay and the payment hosts implement standard authentication methods.
- __Observation:__ Liberapay authenticates the two payment hosts it works with (Strip and PayPal) by verifying the connection each time communication is initiated. Upon the initialization of a session with one of the two payment hosts, Liberapay sends an encrypted authorization header with the given secret code. Connection is only fully established if the appropriate response is sent from the payment host. For this reason, the threat originating from the possibility of spoofing a payment host is addressed by the Liberapay system.

Authentication can be found [here](https://github.com/liberapay/liberapay.com/blob/9739f0366d962274fa10a9e371dbb8e2d2fba4c8/liberapay/payin/paypal.py)

13. _Not Applicable_

14. _Data Flow Credentials Is Potentially Interrupted_
- Description: An external agent interrupts data flowing across a trust boundary in either direction.
- Justification: HTTPs protocol and encryption should mitigate this threat.
- __Observation:__ The Liberapay system encrypts data which crosses the application boundary between itself and its payment hosts. This is done via a modified Fernet protocol where messages are first serialized using CBOR. Then, the serialized messages are encrypted via an AES cipher. Liberapay enforces the use of the HTTPS protocol for requests/replies across the application boundary between itself and the payment hosts. The codebase enforces the use of HTTPS for internal links and system generated communications, and it is assumed that payment hosts send via HTTPS as well. For messages crossing the application boundary, this process flow adequately addresses the threat of concern here as credentials being sent across the application boundary or replies from the payment host are sent via HTTPS. The only gap that exists occurs from the side of the payment host, but as they are an external interactor it is unclear whether they enforce sending messages via the HTTPS protocol (although it is strongly assumed).

Encryption is currently done via the Fernet protocol and can be found [here](https://github.com/liberapay/liberapay.com/blob/77f6df133ee434495e2f268d3682a711142513ea/liberapay/security/crypto.py)
HTTPS connection to payment hosts can be found [here](https://github.com/liberapay/liberapay.com/blob/2cb5fb4f9f0849a5d188773981b0fb89f4747627/www/payment-providers/%25provider/connect.spt)

15. _Data Flow Info Request Is Potentially Interrupted_
- Description: An external agent interrupts data flowing across a trust boundary in either direction.
- Justification: Should be mitigated through the use of HTTPS. 
- __Observation:__ Liberapay mitigates interruptions to data flowing across the Database boundary in either direction through the use of the HTTPS protocol. Messages originating from the Liberapay system are automatically enforced to send in the HTTPS protocol, so interruptions occuring across the boundary are secured by this protocol. Alternatively, interruptions from Amazon Web Services into the Liberapay system are assumed to use HTTPS (although this is unconfirmed as it originates from an external interactor). This presents a gap in the threat mitigation across this boundary. The Liberapay system addresses this through the use of rate-limitation techniques as well as request/reply messaging. This addresses the potential gap by refusing connections that originate from protocols other than HTTPS.

HTTP rate-limitation for queries can be found [here](https://github.com/liberapay/liberapay.com/commit/f73b4f23d28aaf19b0e1e6c0b257397e40dfee77)

16. _Not Applicable_

17. _Spoofing of the Amazon AWS Database External Destination Entity_
- Description: Amazon AWS Database may be spoofed by an attacker and this may lead to data being sent to the attacker's target instead of Amazon AWS Database. Consider using a standard authentication mechanism to identify the external entity.
- Justification: Liberapay uses standard authentication mechanisms and HTTPS.
- __Observation:__ The Liberapay system authorizes the initial database connection in a configuration file that specifies the hostname, port, and password. This is a persistent connection which initially authorizes the correct external interactor to interface with. Apart fromt the initialized connection, the authenticity of the database connection is checked through the use of a session manager which tokenizes each session and subsequent database connection. Apart from those authentication mechanisms, communications performed between the Liberapay system and Amazon Web Services are conducted via the HTTPS protocol.

The closed issue related to the Amazon Database and authentication can be found [here](https://github.com/liberapay/liberapay.com/issues/553)
Database environment configuration can be found [here](https://github.com/liberapay/liberapay.com/blob/00a0059ffe63dc6171a0ffcd0090a84c005763d8/.ebextensions/01_env.config)
Authentication code file can be found [here](https://github.com/liberapay/liberapay.com/blob/f57a9fa44ce79a5339049603728be5f6a8334980/liberapay/security/authentication.py).

18. _Spoofing of the User External Destination Entity_
- Description: User may be spoofed by an attacker and this may lead to data being sent to the attacker's target instead of User. Consider using a standard authentication mechanism to identify the external entity.
- Justification: Standard authentication methods and two factor authentication should reduce the threat of this happening.
- __Observation:__ Liberapay does not currently have a two-factor authentication process in place. This presents a gap in the security enhancements offered by the platform in regard to protecting user accounts from spoofing. Alternatively, there are some mitigations in place that don't utilize 2FA to prevent the spoofing of user accounts. These include session management, as well as email based authorization (which acts like 2 factor authentication). Session management only mitigates the threat of altered user accounts after the initial session is established. To authenticate a user however, Liberapay provides the ability for a user to login via email link instead of direct password. This still presents a gap in verifying the authenticity of a user, but allows for a slight added layer of protection.

Authentication code file can be found [here](https://github.com/liberapay/liberapay.com/blob/f57a9fa44ce79a5339049603728be5f6a8334980/liberapay/security/authentication.py).
Potential incorporation of 2FA [here](https://github.com/liberapay/liberapay.com/issues/926)

19. _External Entity User Potentially Denies Receiving Data_
- Description: User claims that it did not receive data from a process on the other side of the trust boundary. Consider using logging or auditing to record the source, time, and summary of the received data.
- Justification: Audits and Logs should mitigate this threat. 
- __Observation:__ Liberapay has an admin interface that allows admins to perform several actions, such as audit log/monitoring activities, viewing email addresses, notifications, payments, rate limits, as well as users, etc.
Along with that, Liberapay also logs actions performed by admins. In this way, if an admin account was ever compromised, Liberapay would be able to analyze the logs to troubleshoot the issue.
Liberapay audits and logs notifications, schedules, payments, and more. The code for the audits/logs can be found in this [folder](https://github.com/liberapay/liberapay.com/tree/17fd4d3d2f16703bd24a082fe20733da980ced46/www/admin).

20. _Data Flow Reminder Emails Is Potentially Interrupted_
- Description: An external agent interrupts data flowing across a trust boundary in either direction.
- Justification: Liberapay maintains a schedule of sent reminders. Even if one is lost, another one will be sent after some time.
- __Observation:__ Liberapay has a system that sends reminders, mostly for donation renewal, to the concerned parties. In an event that a DoS attack is peformed and a reminder is not consequently sent, Librapay will re-send that notification after some time since it keeps track of the notifications sent. This [link](https://github.com/liberapay/liberapay.com/pull/1193/commits/9266edad3949d30cd8da31f7163e39394102c64c) showcases the donation reminder notification process.

21. _Elevation by Changing the Execution Flow in Liberapay_
- Description: An attacker may pass data into Liberapay in order to change the flow of program execution within Liberapay to the attacker’s choosing.
- Justification: HTTPs protocol/encryption as well as input validation should mitigate the chance of response hijacking.
- __Observation:__ Liberapay leverages https, ensuring that their communications are encrypted according to the TLS encryption algorithm. This also means that their session keys are generated from random data at the time of session initialization. These keys are also short-lived, ensuring that even if the attackers acquire a key through theft, they will not be able to use it for long. One can notice the utlization of https on the [Liberapay's homepage](https://liberapay.com/). Adding to that, Liberapay implements symmetric encryption and decryption to ensure that sensitive data are protected. They currently rely on Fernet, which uses the AES cipher in CBC mode with PKCS7 padding and a 128 bits key. For authentication, they use HMAC-SHA256 with a 128 bits key. ([Crytography Code](https://github.com/liberapay/liberapay.com/blob/fb1dbeac869d235abf25f086cbc5b274931578d1/liberapay/security/crypto.py))
As far as input validation, Liberapay validates certain aspects of input. However, there is insufficient evidence to claim that all inputs are validated. See examples below:
1) [Example of implemented input validation](https://github.com/liberapay/liberapay.com/issues/1480)
2) [Example of yet to be implemented input validation](https://github.com/liberapay/liberapay.com/issues/70)

22. _Not Applicable_

23. _Not Applicable_

24. _Data Flow Response Is Potentially Interrupted_
- Description: An external agent interrupts data flowing across a trust boundary in either direction.
- Justification: Should be mitigated through the use of HTTPS and firewalls.
- __Observation:__ Liberapay affirms that "All network connections are encrypted, except for some communications between machines located in the same datacenter".
Furthermore, as described in _Mitigation 21_, Liberapay leverages https, ensuring that their communications are encrypted according to the TLS encryption algorithm. However, Liberapay does not appear to implement firewalls, which could mitigate this issue and reduce DoS attacks. Liberapay and its contributors did discuss the idea of implementing a firewall, but it has yet to be done. ([Discussion](https://github.com/liberapay/liberapay.com/issues/709)). This could potentially be a gap as it could potentially undermine Liberapay's network service or connectivity's robustness. However, Liberapay does implement some rate limiting techniques, aimed at preventing DoS attacks as explained in this [discussion](https://github.com/liberapay/liberapay.com/pull/699).

25. _Potential Process Crash or Stop for Liberapay_
- Description: Liberapay crashes, halts, stops or runs slowly; in all cases violating an availability metric.
- Justification: May be outstanding issues that causes this behavior; however, Liberapay is generally a functional application and the threat of this is low.
- __Observation:__ As explained in the justification, this threat is low as Liberapay is generally a functional application. Among things that slow, stop, or crash Liberapay are repeated attempts by an attacker to do a task (i.e. bruteforce password guessing). As mentioned in the _Mitigation 24_, Liberapay did incorporate code to mitigate such events. See _Mitigation 24_ for more information.

26. _Data Flow Sniffing_
- Description: Data flowing across Response may be sniffed by an attacker. Depending on what type of data an attacker can read, it may be used to attack other parts of the system or simply be a disclosure of information leading to compliance violations. Consider encrypting the data flow.
- Justification: HTTPS protocol and encryption should mitigate this threat.
- __Observation:__ Please view _Mitigation 21_, as it highlights steps taken to secure communication and encrypt data flow.

27. _Not Applicable_

28. _Potential Lack of Input Validation for Liberapay_
- Description: Data flowing across Response may be tampered with by an attacker. This may lead to a denial of service attack against Liberapay or an elevation of privilege attack against Liberapay or an information disclosure by Liberapay. Failure to verify that input is as expected is a root cause of a very large number of exploitable issues. Consider all paths and the way they handle data. Verify that all input is verified for correctness using an approved list input validation approach.
- Justification: The use of secure HTTPs protocol should reduce the possibility of request tampering. However, an investigation into Liberapay's request verification may be useful.
- __Observation:__ Please view _Mitigation 21_, as it highlights steps taken to secure communication and encrypt data flow.

29 _Spoofing the Amazon AWS Database External Entity_
- Description: Amazon AWS Database may be spoofed by an attacker and this may lead to unauthorized access to Liberapay. Consider using a standard authentication mechanism to identify the external entity.
- Justification: Liberapay uses standard authentication mechanisms and HTTPs protocols to mitigate this threat.
- __Observation:__ As explained in _Mitigation 21_, Liberapay has taken steps taken to secure communication and encrypt data flow. Adding to that, they also provide authentication mechanishms at various points during interaction with other entities that identify external entities and users to prevent attackers from spoofing and getting unauthorized access. 

30. _Not Applicable_ 

31. _Not Applicable_

32 _Spoofing the Payment Host External Entity_
- Description: Payment Host may be spoofed by an attacker and this may lead to unauthorized access to Liberapay. Consider using a standard authentication mechanism to identify the external entity.
- Justification: :	Liberapay uses a standard authentication mechanism.
- __Observation:__  As addressed in some of the cases above. Liberapay utilizes a standard authentication mechanism at various points in their workflows, therefore spoofing of external hosts is unlikely to happen and therefore mitigating the possiblity of such an attack to occur. 

33 _Potential Lack of Input Validation for Liberapay_
- Description: Data flowing across Verification may be tampered with by an attacker. This may lead to a denial of service attack against Liberapay or an elevation of privilege attack against Liberapay or an information disclosure by Liberapay. Failure to verify that input is as expected is a root cause of a very large number of exploitable issues. Consider all paths and the way they handle data. Verify that all input is verified for correctness using an approved list input validation approach.
- Justification: Liberapay uses HTTPS protocol to mitigate this threat. Liberapay should verify input is as expected.
- __Observation:__  As discussed in _Mitigation_21, Liberapay does indeed secure communication and encrypt data flow. But it does not have appear to have any protections in place that prevent a denial of service attack, therefore that poses a risk to the 

34. _Not Applicable_

35 _Data Flow Sniffing_
- Description: Data flowing across Verification may be sniffed by an attacker. Depending on what type of data an attacker can read, it may be used to attack other parts of the system or simply be a disclosure of information leading to compliance violations. Consider encrypting the data flow.
- Justification: Liberapay uses HTTPS to secure communications, which mitigates this threat.
- __Observation:__  Liberapay utilizes HTTP to secure it's communications, and therefore this threat is mitigated.  See _Mitigation 21_ for additional details. 

36 _Potential Process Crash or Stop for Liberapay_
- Description: Liberapay crashes, halts, stops or runs slowly; in all cases violating an availability metric.
- Justification: May be outstanding issues that cause this behavior; however, Liberapay is generally a functional application and the threat of this is low. 
- __Observation:__ A DDoS attack could indeed impact Liberapay. From our initial investigation; there is no evidence that Liberapay employs any protections against DDoS attacks, if such an attack occurrs then there is a risk on Liberapay and it could definitely impact it's services and make their website unresponsivness. 

37 _Data Flow Verification Is Potentially Interruptedy_
- Description: An external agent interrupts data flowing across a trust boundary in either direction.
- Justification: The use of HTTPS protocol should mitigate this, but it warrants further investigation concerning the possibility of this attack.
- __Observation:__  As explained in Mitigation 37. Liberapay does not utilize any protections against DDoS attacks and therefore a risk does exist. 

38. _Not Applicable_

39. _Not Applicable_

40 _Elevation by Changing the Execution Flow in Liberapay_
- Description: An attacker may pass data into Liberapay in order to change the flow of program execution within Liberapay to the attacker's choosing.
- Justification: HTTPS should prevent the hijacking of communication requests to accomplish this.
- __Observation:__  As addressed in _Mitigation 21_ , Liberapay encrypts it's communication which prevents such threats from occuring. 

41 _Cross Site Request Forgery_
- Description: Cross-site request forgery (CSRF or XSRF) is a type of attack in which an attacker forces a user's browser to make a forged request to a vulnerable site by exploiting an existing trust relationship between the browser and the vulnerable web site.  In a simple scenario, a user is logged in to web site A using a cookie as a credential.  The other browses to web site B.  Web site B returns a page with a hidden form that posts to web site A.  Since the browser will carry the user's cookie to web site A, web site B now can take any action on web site A, for example, adding an admin to an account.  The attack can be used to exploit any requests that the browser automatically authenticates, e.g. by session cookie, integrated authentication, IP whitelisting. The attack can be carried out in many ways such as by luring the victim to a site under control of the attacker, getting the user to click a link in a phishing email, or hacking a reputable web site that the victim will visit. The issue can only be resolved on the server side by requiring that all authenticated state-changing requests include an additional piece of secret payload (canary or CSRF token) which is known only to the legitimate web site and the browser and which is protected in transit through SSL/TLS. See the Forgery Protection property on the flow stencil for a list of mitigations.
- Justification: Use of HTTPS protocols and encryption should mitigate this threat by protected session information in transit.
- __Observation:__ As addressed in _Mitigation 21_ , Liberapay encrypts it's communication which prevents such threats from occuring. 

## 3. GitHub Information

Here are links to our GitHub Pages: \
Master Branch: [Home Page](https://github.com/JustinRobbins7/CSCI-8420-Team-1) \
Issues Page: [Issues Page](https://github.com/JustinRobbins7/CSCI-8420-Team-1/issues) \
Project Board: [Project Board](https://github.com/JustinRobbins7/CSCI-8420-Team-1/projects/2)

Contribution Records: \
GitHub Pulse: [Pulse Page](https://github.com/JustinRobbins7/CSCI-8420-Team-1/pulse) \
GitHub Contributors: [Contributors Page](https://github.com/JustinRobbins7/CSCI-8420-Team-1/graphs/contributors) 


## 4. Teamwork Reflection

For this project deliverable, team members continued to meet regularly after a brief hiatus for Fall Break. Each team member was initially tasked with familiarizing themselves with DFD diagrams as well as the Microsoft TMT. After meting with Dr. Ghandi, we gained clarity on requirements for the deliverable and were able to make significant progress towards the document. We met prior to the deadline an additional time to regroup and coordinate with each other on tasks left to accomplish. All team members were then provisioned a section of the threat analysis report to investigate on the OSS platform. With tasks delegated, the assignment progressed smoothly with no conflicts or major impediments.

No major issues occurred during the build and finalization of this deliverable. There was additional clarification needed prior to delivery, but was mitigated via e-mail correspondence. For upcoming tasks we plan to continue our weekly team meetings and keep everyone up-to-date on both GitHub and other communication platforms.
